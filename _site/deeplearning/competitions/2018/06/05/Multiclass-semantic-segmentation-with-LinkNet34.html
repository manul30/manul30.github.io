<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>Multiclass semantic segmentation with LinkNet34 - Computer Vision Lab</title>
        <meta name="author" content="Manuel Carita" />
        <meta name="description" content="Multiclass semantic segmentation with LinkNet34" />
        <meta name="keywords" content="Multiclass semantic segmentation with LinkNet34, Computer Vision Lab, DeepLearning, Competitions" />

        <meta content="" property="fb:app_id">
        <meta content="Computer Vision Lab" property="og:site_name">
        
          <meta content="Multiclass semantic segmentation with LinkNet34" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="A Robotics, Computer Vision and Machine Learning lab by Manuel Carita. The main focus of the blog is Self-Driving Car Technology and Deep Learning.
" property="og:description">
        
        
          <meta content="http://localhost:4000/deeplearning/competitions/2018/06/05/Multiclass-semantic-segmentation-with-LinkNet34.html" property="og:url">
        
        
          <meta content="2018-06-05T04:00:00-05:00" property="article:published_time">
          <meta content="http://localhost:4000/about/" property="article:author">
        
        
          <meta content="http://localhost:4000/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="DeepLearning" property="article:section">
          
        
        
          
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@">
        <meta name="twitter:creator" content="@">
        
          <meta name="twitter:title" content="Multiclass semantic segmentation with LinkNet34">
        
        
          <meta name="twitter:url" content="http://localhost:4000/deeplearning/competitions/2018/06/05/Multiclass-semantic-segmentation-with-LinkNet34.html">
        
        
          <meta name="twitter:description" content="A Robotics, Computer Vision and Machine Learning lab by Manuel Carita. The main focus of the blog is Self-Driving Car Technology and Deep Learning.
">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'http://localhost:4000';</script>
      
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <!-- Core BootStrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
      <div class="container">
        <div class="row">
          <div class="col-md-5 col-sm-5 col-xs-12">
            <div class="row-picture">
              <img id="about" class="logo-img" src="/static/img/logo.png" height="75px" width="75px">
            </div>
            <div class="row-details">
              <h3 class="list-group-item-heading" style="padding-top: 15%;font-size: 32px">Manuel Carita</h3>
              <h5 class="list-group-item-heading">Mechatronics Engineer</h5>
              <div class="social-icons">
	
        <a class="icon" target="_blank" href="https://www.linkedin.com/in/manuelcarita"><i class="fa fa-linkedin"></i></a>
    
        <a class="icon" target="_blank" href="https://github.com/manul30"><i class="fa fa-github"></i></a>
    
</div>

            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <div class="col-md-7 col-sm-7 col-xs-12">
          <div class="row">
            <h2 class="blog-title-pro " style="padding-top: 5%;padding-left: 40%;font-size: 24px;">Multiclass semantic segmentation with LinkNet34</h2>
            
            </div>
            <p class="info">
              
                <span class="time">05 Jun 2018</span>
              
              
                <span class="categories">
                  &raquo; 
                  
                    <a href="/category/DeepLearning">DeepLearning</a>
                    , 
                  
                    <a href="/category/Competitions">Competitions</a>
                    
                  
                </span>
              
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="list-separator nav navbar-nav well well-primary post">

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12 current-menu-item Multiclass-semantic-segmentation-with-LinkNet34.html"><a href="/" target="_self"><i class="fa fa-home"></i> Home</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Multiclass-semantic-segmentation-with-LinkNet34.html"><a href="/projects" target="_self"><i class="fa fa-desktop"></i> Projects</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Multiclass-semantic-segmentation-with-LinkNet34.html"><a href="/about" target="_self"><i class="fa fa-user"></i> About me</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Multiclass-semantic-segmentation-with-LinkNet34.html"><a href="/resume" target="_self"><i class="fa fa-graduation-cap"></i> Profile</a></li>

</ul>

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <div class="post-content well">
<article class="content">
    <div class="post-head">
    <h1><b>Multiclass semantic segmentation with LinkNet34 </b></h1>
    </div>
    <p>June 05, 2018</p>
    <p>

  6 mins read

</p>
    <div class="post"><h2 id="software-and-hardware">Software and Hardware</h2>

<p>The model used in the submission as well as previous experiments were prepared with use of different machines and GPUs depends on their availability and spare time. The variety of video cards includes Nvidia GTX 1070, 1080 Ti, Tesla V100 (as a p3.2xlarge AWS instance).</p>

<p>The deep neural network was implemented with <a href="https://pytorch.org">PyTorch</a> 0.4 framework. The framework was chosen for its flexibility, which is comparable to TensorFlow, and simplicity of prototyping on a par with Keras. The great fast and easy to use dataloader is also a huge advantage of the deep learning framework.</p>

<p>NumPy and OpenCV libraries were involved in data preparation and postprocessing. However, PyTorch itself played a crucial rule in predictions postprocessing as it can be used for some computer vision image processing (such as morphological dilation and erosion operations) right on GPU. This helped a lot in the pipeline speeding up.</p>

<h2 id="data-and-preprocessing">Data and preprocessing</h2>

<p>Samples from the official train dataset, as well as provided by the community datasets and manually generated ones were utilized for training and validation. Totally, there were 15601 images in train subset and 1500 in the validation one.</p>

<p>The generated images were manually filtered in order to exclude a long series of frames without of any movements. Such may occur when the car is stopped at a red traffic light, and not a lot of moving other cars are visible. Such series of same images may lead to overfitting to them, that is why such cases were removed from the training and validation datasets.</p>

<p>Binary labeled images for vehicles and binary labeled images for the drivable surface of the road were generated out of the provided label images with help of NumPy and openCV. The camera-carrier vehicle hood was excluded from labeling as it is required by the challenge rules. An additional background class was defined as “everything except the road and vehicles”. So, the target was organized as a three channel binary image.</p>

<p><img src="/assets/post11/target.jpg" alt="Target preporation" /></p>

<p><em>Left to right: original image; raw masks; preprocessed target masks.</em></p>

<p>Images were <a href="https://github.com/NikolasEnt/Lyft-Perception-Challenge/blob/master/dataprocess.py">augmented</a> online during training by random gamma, color, and brightness adjustment. The augmentation was done right on a GPU for training time reduction.</p>

<p><img src="/assets/post11/augmentation.jpg" alt="Augmentation" /></p>

<p><em>Example of a train image augmentation.</em></p>

<h2 id="model">Model</h2>

<p><a href="https://arxiv.org/abs/1505.04597">U-Net</a> like encoder-decoder architectures of fully convolutional neural networks with skip-connections (for spatial information lost prevention) are proved to be great in semantic segmentation tasks. For the competition, a <a href="https://arxiv.org/abs/1707.03718">LinkNet34</a> architecture was chosen because it is quite fast and accurate and it was successfully used by many teams in other semantic segmentation <a href="https://arxiv.org/abs/1803.01207v1">competitions</a> on Kaggle or other platforms.</p>

<p><img src="/assets/post11/LinkNet34.png" alt="LinkNet34" />
<em>The LinkNet34 architecture with ResNet34 encoder. Picture from a MICCAI 2017 Endoscopic Vision SubChallenge: Robotic Instrument Segmentation <a href="https://arxiv.org/abs/1803.01207v1">report</a> by Alexey Shvets, Alexander Rakhlin, Alexandr Kalinin and Vladimir Iglovikov.</em></p>

<p>The architecture uses <a href="https://arxiv.org/abs/1512.03385">ResNet34</a> as an encoder and correspondent decoder blocks based on transposed convolutions with the same number of filters as encoders blocks on the same scale. The model code is organized so it is very simple to change the encoder architecture (select encoder from a list of available ResNets implemented in the PyTorch model zoo) or change the output layer. In the case, softmax layer was used for output as classes are expected to be not overlayed. However, some experiments with sigmoid were also carried out.</p>

<h2 id="training">Training</h2>

<p>For loss (1 - target metric of average F<sub>0.5</sub>(road) and F<sub>2</sub>(car)) was applied. It is quite similar to standard Dice index loss but introduces desired ratio of precision/recall. Such loss produced better results as compared to BCELoss during experiments. Different weights were tested. It was found out, that in this particular challenge, use of BCE loss component does not improve results. Finally, balanced weights were chosen. So, the loss looks like this:</p>

<p><strong>Loss = (1 - F<sub>2</sub>(car)) + (1 - F<sub>0.5</sub>(road)) + (1 - F<sub>1</sub>(background))</strong></p>

<p>The code is organized in such way that makes it simple to experiment with different weights of different classes as well as change beta in F-beta scores.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">torch</span>

<span class="n">smooth</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="k">def</span> <span class="nf">fb_loss</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="n">trues</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="n">beta</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="n">preds</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trues</span> <span class="o">=</span> <span class="n">trues</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">trues</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">TP</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">*</span> <span class="n">trues</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">FP</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">trues</span><span class="p">))</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">FN</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">preds</span><span class="p">)</span> <span class="o">*</span> <span class="n">trues</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Fb</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">TP</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mi">1</span><span class="o">+</span><span class="n">beta2</span><span class="p">)</span> <span class="o">*</span> <span class="n">TP</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">FP</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
    <span class="n">Fb</span> <span class="o">=</span> <span class="n">Fb</span> <span class="o">*</span> <span class="n">weights</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">Fb</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span></pre></td></tr></tbody></table></code></pre></figure>

<p><em>F-beta score calculation for a batch of images with PyTorch</em></p>

<p>The best checkpoint for the submit was chosen by max score metric, which is the same as the evaluation function used on the leaderboard:</p>

<p><strong>Score = (F<sub>0.5</sub>(road) + F<sub>2</sub>(car))/2</strong></p>

<p>The model was trained with Adam optimizer. Learning rate was manually decreased several times during training. The final learning rates was: 75 epochs with lr=1e-4; 20 epochs with lr=1e-5 and finally 10 epochs with lr=1e-6.</p>

<h2 id="results-postprocessing">Results postprocessing</h2>

<p>The model output is a matrix with elements in the range [0..1] (softmax layer output), so, it should be binarized. A simple thresholding was applied. As recall is more important than precision for the ‘car’ class, so its threshold is quite low. Contrary, the road threshold is high enough.</p>

<p>After binarization of the output, a simple classical computer vision can be applied for the final score improvement. Morphology <a href="https://github.com/NikolasEnt/Lyft-Perception-Challenge/blob/master/dataprocess.py#L130">erosion and dilation</a> operations, which can be performed on the GPU are included in the prediction script. It was observed, that a slight dilation increase the F-score on the ‘car’ class, so it is applied in the final version of the script.</p>

<p>As the car hood is a constant part of a camera image, its pixels were deliberately excluded from predictions. The hood mask was saved from a training image and it was noticed that such simple postprocessing could add a bit to the final score as it removes some wrongly included road pixels on the hood edge. As the process is done on the GPU, the FPS is not significantly reduced by the step.</p>

<p>The project code is available on <a href="https://github.com/NikolasEnt/Lyft-Perception-Challenge">Github</a>.</p>

</div>
    <hr />
    <div class="share-page">
    Share this on &rarr;
 <a href="https://twitter.com/share" class="twitter-share-button" data-via="">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<!-- Google + -->
<div class="g-plus" data-action="share" data-annotation="bubble"></div>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<!-- Facebook -->
<div class="fb-share-button" data-href="http://localhost:4000/deeplearning/competitions/2018/06/05/Multiclass-semantic-segmentation-with-LinkNet34.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</article>
<hr />

<div class="PageNavigation">
  
    <a class="prev pull-left" href="http://localhost:4000/deeplearning/competitions/2018/05/31/About-Lyft-Perception-Challenge.html">&laquo; About Lyft Perception Challenge</a>
  
  
    <a class="next pull-right" href="http://localhost:4000/deeplearning/competitions/2018/06/05/Discussion-of-the-Lyft-Perception-Challenge.html">Discussion of the Lyft Perception Challenge &raquo;</a>
  
</div>



    
    
        
            
        
            
        
    
        
            
                
                <div class="panel-body">
                <h4>Related Posts</h4>
                <ul>
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/hardware,/deeplearning/2018/11/06/Benchmarking-RTX-2080-Ti-vs-Pascal-GPUs-with-DL-tasks.html">Benchmarking RTX 2080 Ti vs Pascal GPUs vs Tesla V100 with DL tasks</a>
                    
                        <small>(Categories: <a href="/category/Hardware,">Hardware,</a>, <a href="/category/DeepLearning">DeepLearning</a>)</small>
                    
                </li>
                
                
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/deeplearning/competitions/2018/10/24/Semantic-Segmentation-of-Seismic-Reflection-Images.html">Semantic Segmentation of Seismic Reflection Images</a>
                    
                        <small>(Categories: <a href="/category/DeepLearning">DeepLearning</a>, <a href="/category/Competitions">Competitions</a>)</small>
                    
                </li>
                
                
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/deeplearning/competitions/2018/10/23/About-Kaggle-TGS-Salt-Identification-Challenge.html">About Kaggle TGS Salt Identification Challenge</a>
                    
                        <small>(Categories: <a href="/category/DeepLearning">DeepLearning</a>, <a href="/category/Competitions">Competitions</a>)</small>
                    
                </li>
                
                
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/deeplearning/competitions/2018/06/05/Discussion-of-the-Lyft-Perception-Challenge.html">Discussion of the Lyft Perception Challenge</a>
                    
                        <small>(Categories: <a href="/category/DeepLearning">DeepLearning</a>, <a href="/category/Competitions">Competitions</a>)</small>
                    
                </li>
                
                
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/deeplearning/competitions/2018/05/31/About-Lyft-Perception-Challenge.html">About Lyft Perception Challenge</a>
                    
                        <small>(Categories: <a href="/category/DeepLearning">DeepLearning</a>, <a href="/category/Competitions">Competitions</a>)</small>
                    
                </li>
                
                
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/deeplearning/competitions/2018/02/21/An-approach-to-predicted-class-balancing.html">An approach to predicted class balancing</a>
                    
                        <small>(Categories: <a href="/category/DeepLearning">DeepLearning</a>, <a href="/category/Competitions">Competitions</a>)</small>
                    
                </li>
                
                
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    

    
    
        
            
        
            
        
    
        
            
        
            
        
    


    </ul>
    </div>


          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
  © 2022-2023 Manuel Carita, <a href="/">Home</a> - Powered by Jekyll with <a href="https://github.com/codeasashu/hcz-jekyll-blog">HCZ Material theme</a>.
</footer>
<div align="center">
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-0000000000000000"
    data-ad-slot="0000000000"
    data-ad-format="auto"></ins>
</div>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104440412-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
