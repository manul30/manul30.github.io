<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>Adaptive Virtual Sensors for Lane detection - Computer Vision Lab</title>
        <meta name="author" content="Manuel Carita" />
        <meta name="description" content="Adaptive Virtual Sensors for Lane detection" />
        <meta name="keywords" content="Adaptive Virtual Sensors for Lane detection, Computer Vision Lab, OpenCV" />

        <meta content="" property="fb:app_id">
        <meta content="Computer Vision Lab" property="og:site_name">
        
          <meta content="Adaptive Virtual Sensors for Lane detection" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="A Robotics, Computer Vision and Machine Learning lab by Manuel Carita. The main focus of the blog is Self-Driving Car Technology and Deep Learning.
" property="og:description">
        
        
          <meta content="http://localhost:4000/opencv/2017/06/07/Adaptive-Virtual-Sensors.html" property="og:url">
        
        
          <meta content="2017-06-07T04:00:00-05:00" property="article:published_time">
          <meta content="http://localhost:4000/about/" property="article:author">
        
        
          <meta content="http://localhost:4000/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="OpenCV" property="article:section">
          
        
        
          
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@">
        <meta name="twitter:creator" content="@">
        
          <meta name="twitter:title" content="Adaptive Virtual Sensors for Lane detection">
        
        
          <meta name="twitter:url" content="http://localhost:4000/opencv/2017/06/07/Adaptive-Virtual-Sensors.html">
        
        
          <meta name="twitter:description" content="A Robotics, Computer Vision and Machine Learning lab by Manuel Carita. The main focus of the blog is Self-Driving Car Technology and Deep Learning.
">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'http://localhost:4000';</script>
      
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <!-- Core BootStrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
      <div class="container">
        <div class="row">
          <div class="col-md-5 col-sm-5 col-xs-12">
            <div class="row-picture">
              <img id="about" class="logo-img" src="/static/img/logo.png" height="75px" width="75px">
            </div>
            <div class="row-details">
              <h3 class="list-group-item-heading" style="padding-top: 15%;font-size: 32px">Manuel Carita</h3>
              <h5 class="list-group-item-heading">Mechatronics Engineer</h5>
              <div class="social-icons">
	
        <a class="icon" target="_blank" href="https://www.linkedin.com/in/manuelcarita"><i class="fa fa-linkedin"></i></a>
    
        <a class="icon" target="_blank" href="https://github.com/manul30"><i class="fa fa-github"></i></a>
    
</div>

            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <div class="col-md-7 col-sm-7 col-xs-12">
          <div class="row">
            <h2 class="blog-title-pro " style="padding-top: 5%;padding-left: 40%;font-size: 24px;">Adaptive Virtual Sensors for Lane detection</h2>
            
            </div>
            <p class="info">
              
                <span class="time">07 Jun 2017</span>
              
              
                <span class="categories">
                  &raquo; 
                  
                    <a href="/category/OpenCV">OpenCV</a>
                    
                  
                </span>
              
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="list-separator nav navbar-nav well well-primary post">

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12 current-menu-item Adaptive-Virtual-Sensors.html"><a href="/" target="_self"><i class="fa fa-home"></i> Home</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Adaptive-Virtual-Sensors.html"><a href="/projects" target="_self"><i class="fa fa-desktop"></i> Projects</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Adaptive-Virtual-Sensors.html"><a href="/about" target="_self"><i class="fa fa-user"></i> About me</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  Adaptive-Virtual-Sensors.html"><a href="/resume" target="_self"><i class="fa fa-graduation-cap"></i> Profile</a></li>

</ul>

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <div class="post-content well">
<article class="content">
    <div class="post-head">
    <h1><b>Adaptive Virtual Sensors for Lane detection </b></h1>
    </div>
    <p>June 07, 2017</p>
    <p>

  5 mins read

</p>
    <div class="post"><h2 id="introduction">Introduction</h2>

<p>One may use different approaches based on combination of threshold filters for defining pixels on an image, which represent the lane line. However, it can be quite challenging because the lighting conditions may vary even in one video frame from the front facing camera due to shadows appearing and etc. That is why, an adaptive approach with virtual sensors is proposed here.</p>

<h2 id="key-ideas">Key ideas</h2>

<ul>
  <li>
    <p>Image can be analyzed with Adaptive Virtual Sensors. Each sensor is a string of pixels (for example, 30 pixels long) in the area where it is expected to find a line.  Virtual sensor can find the line position or can find nothing. The point with the maximum value (brightness) in the virtual sensor is a suspected line point. Line point considered found if its value minus the mean pixels value of the sensor is larger than the threshold and the point is shifted from the sensers center on less than <code class="highlighter-rouge">DEV</code> pixels.</p>
  </li>
  <li>
    <p>Image is analyzed from the bottom to the top because it is the most probable to find a line on the closest to the car road pixels because resolution is higher near to the hood. Position of the next sensor is predicted by position of the previous line point (in case of a still image) position or calculated from the polinomial fit of points which were found on the previous frame (in case of a video).</p>
  </li>
  <li>
    <p>Threshold value should be selected independently for each virtual sensor based on mean value of pixels in the sensor. In general, the threshold should be as large as possible to reduce false positive results. But in the bright areas it should be less because the region marred by the sunlight and  line contrast decreased. It should also be less for the dark areas, as the line is poorly distinguishable in the dark. It allows to find line points on an image with both deep shadows and bright areas which is very challenging in case of using a constant threshold for the whole image.</p>
  </li>
  <li>
    <p>Polynomial fit on the set of points, found by virtual sensors, is then applied. The best order of the polynomial should be chosen for each points set individually.</p>
  </li>
  <li>
    <p>If only one line is visible, then the second can be carried out as an equidistant at road width distance from the first one.</p>
  </li>
</ul>

<h2 id="order-of-a-polynomial">Order of a polynomial</h2>

<p>One of the key ideas of the project is the usage of the reasonable minimal order of polinomial functions for lines fitting (order should be in range [1,3]). The function  <code class="highlighter-rouge">best_pol_ord</code> chooses such order. It starts from a linear function and, if it does not perform well enough, increases the polinomial order (up to 3). It returns polinomial coefficients and mean squared error of the selected approximation. The function stops increasing the order if it does not help (mean squared error drops not significant in case of higher order) or in case the mean squared error is small enough (<code class="highlighter-rouge">&lt; DEV_POL</code>).</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>

<span class="n">DEV_POL</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Max mean squared error of the approximation
</span><span class="n">MSE_DEV</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="c1"># Minimum mean squared error ratio to consider higher order of the polynomial
</span><span class="k">def</span> <span class="nf">best_pol_ord</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">pol1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pred1</span> <span class="o">=</span> <span class="n">pol_calc</span><span class="p">(</span><span class="n">pol1</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mse1</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pred1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mse1</span> <span class="o">&lt;</span> <span class="n">DEV_POL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pol1</span><span class="p">,</span> <span class="n">mse1</span>
    <span class="n">pol2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">pred2</span> <span class="o">=</span> <span class="n">pol_calc</span><span class="p">(</span><span class="n">pol2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">mse2</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pred2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mse2</span> <span class="o">&lt;</span> <span class="n">DEV_POL</span> <span class="ow">or</span> <span class="n">mse1</span> <span class="o">/</span> <span class="n">mse2</span> <span class="o">&lt;</span> <span class="n">MSE_DEV</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pol2</span><span class="p">,</span> <span class="n">mse2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pol3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">pred3</span> <span class="o">=</span> <span class="n">pol_calc</span><span class="p">(</span><span class="n">pol3</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">mse3</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pred3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mse2</span> <span class="o">/</span> <span class="n">mse3</span> <span class="o">&lt;</span> <span class="n">MSE_DEV</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pol2</span><span class="p">,</span> <span class="n">mse2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pol3</span><span class="p">,</span> <span class="n">mse3</span></code></pre></figure>

<p>It is possible to use a simple low pass filter or an alpha-beta filter for smoothing polynomial coefficients of the same degree. But for two polynomial with different orders a dedicated function <code class="highlighter-rouge">smooth_dif_ord</code> can be introduced. It calculates average <em>x</em> position of points for a given function <em>f(y)</em> at <em>y</em> values from the new dataset and fit these new average points with polinomial of desired degree.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Smooth polinomial functions of different degrees   
</span><span class="k">def</span> <span class="nf">smooth_dif_ord</span><span class="p">(</span><span class="n">pol_p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">new_ord</span><span class="p">):</span>
    <span class="n">x_p</span> <span class="o">=</span> <span class="n">pol_calc</span><span class="p">(</span><span class="n">pol_p</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">x_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">x_p</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x_new</span><span class="p">,</span> <span class="n">new_ord</span><span class="p">)</span></code></pre></figure>

<h2 id="the-pipeline-demonstration">The pipeline demonstration</h2>

<p>After image warping the algorithm perform points finding by the described above in the <em>Key ideas</em> section points finding approach. Basically, virtual sensors are filters with an adaptive region-of-interest and adaptive threshold.</p>

<p>Each virtual sensor considers points which have values higher than mean pixel value in the sensor plus the threshold value (it is a kind of local binary image for the virtual sensor). The threshold value is calculated for each sensor individually based on the mean value of pixels in the sensor. The line point is the pixel with the maximum value among all considered pixels. The sensor position (ROI) determinated by the position of the previously detected line point (for still images) or by the polynomial fit of line points from the previous frame (for videos).</p>

<p><img src="/assets/post4/pipeline1.jpg" alt="readme_img/pipeline1.jpg" />
<img src="/assets/post4/pipeline2.jpg" alt="readme_img/pipeline2.jpg" />
<img src="/assets/post4/pipeline3.jpg" alt="readme_img/pipeline3.jpg" />
<img src="/assets/post4/pipeline4.jpg" alt="readme_img/pipeline4.jpg" />
<img src="/assets/post4/pipeline5.jpg" alt="readme_img/pipeline5.jpg" /></p>

<p>Code of the discussed approach is availuabe on Github in the project <a href="https://github.com/NikolasEnt/Advanced-Lane-Lines/blob/master/LaneLine_debug.ipynb">repo</a>.</p>

</div>
    <hr />
    <div class="share-page">
    Share this on &rarr;
 <a href="https://twitter.com/share" class="twitter-share-button" data-via="">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<!-- Google + -->
<div class="g-plus" data-action="share" data-annotation="bubble"></div>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<!-- Facebook -->
<div class="fb-share-button" data-href="http://localhost:4000/opencv/2017/06/07/Adaptive-Virtual-Sensors.html" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</article>
<hr />

<div class="PageNavigation">
  
    <a class="prev pull-left" href="http://localhost:4000/opencv/2017/05/07/Bird's-Eye-View-Transformation.html">&laquo; Bird's Eye View Transformation</a>
  
  
    <a class="next pull-right" href="http://localhost:4000/classifier/2017/08/01/Image-classification-using-SVM.html">Image classification using SVM &raquo;</a>
  
</div>



    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    
        
            
        
    

    
    
        
            
        
    

    
    
        
            
        
    

    
    
        
            
        
    

    
    
        
            
        
    

    
    
        
            
                
                <div class="panel-body">
                <h4>Related Posts</h4>
                <ul>
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/opencv/2017/05/07/Bird's-Eye-View-Transformation.html">Bird's Eye View Transformation</a>
                    
                        <small>(Categories: <a href="/category/OpenCV">OpenCV</a>)</small>
                    
                </li>
                
                
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="http://localhost:4000/opencv/2017/05/05/Camera-calibration-with-OpenCV.html">Camera calibration with OpenCV</a>
                    
                        <small>(Categories: <a href="/category/OpenCV">OpenCV</a>)</small>
                    
                </li>
                
                
            
        
    

    
    
        
            
        
    
        
            
        
    


    </ul>
    </div>


          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
  © 2022-2023 Manuel Carita, <a href="/">Home</a> - Powered by Jekyll with <a href="https://github.com/codeasashu/hcz-jekyll-blog">HCZ Material theme</a>.
</footer>
<div align="center">
  <ins class="adsbygoogle"
    style="display:block"
    data-ad-client="ca-pub-0000000000000000"
    data-ad-slot="0000000000"
    data-ad-format="auto"></ins>
</div>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-104440412-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
